---
- name: configure ssl certificate
  copy:
    content="{{ passenger_nginx_ssl_cert }}"
    dest="{{ passenger_nginx_ssl_cert_dir }}/{{ passenger_nginx_ssl_cert_file }}"
    owner=root
    group=root
    mode=0640
  when: passenger_nginx_ssl

- name: configure ssl key
  copy:
    content="{{ passenger_nginx_ssl_key }}"
    dest="{{ passenger_nginx_ssl_cert_dir }}/{{ passenger_nginx_ssl_key_file }}"
    owner=root
    group=root
    mode=0640
  when: passenger_nginx_ssl

- name: template nginx.conf
  template:
    src=nginx.conf.j2
    dest=/etc/nginx/nginx.conf
  notify:
    - restart nginx

- name: remove nginx default.conf
  file:
    path="{{ item }}"
    state=absent
  with_items: "{{ passenger_nginx_default_site }}"
  notify:
    - restart nginx

- name: template nginx foreman.conf
  template:
    src=foreman.conf.j2
    dest="{{ passenger_nginx_cfg_dir }}/foreman.conf"
  notify:
    - restart nginx

- name: restart nginx passenger
  service:
    name=nginx
    state=restarted
  when: passenger_nginx_register_installation.changed
